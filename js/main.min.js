!function(){var j,l,a=960,b=680,c=[[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,30,30,30,30,30,30,30,4,30,30,30,4,30,30,30,4,30,30,4],[4,30,4,30,4,30,30,30,30,30,4,30,4,30,4,30,4,4,30,4],[4,30,4,30,4,30,4,30,4,30,4,30,4,30,4,30,30,4,30,4],[4,30,4,30,30,30,4,30,4,30,30,30,30,30,4,4,30,4,30,4],[4,30,4,4,4,30,4,30,4,4,4,4,4,30,30,4,30,4,30,4],[4,30,30,30,30,30,30,30,4,30,4,30,4,4,30,30,30,30,30,4],[4,4,4,30,4,30,4,4,4,30,4,30,30,30,30,4,4,4,4,4],[4,30,30,30,4,30,4,30,30,30,30,30,4,4,30,4,30,30,30,4],[4,30,4,4,4,30,30,30,30,30,30,30,30,30,30,4,30,4,30,4],[4,30,30,30,4,4,4,30,30,30,30,30,4,4,4,4,30,4,30,4],[4,30,4,30,30,30,4,30,4,30,30,30,30,30,30,30,30,4,30,4],[4,30,4,4,4,30,4,30,4,30,4,4,4,4,30,4,30,4,4,4],[4,30,30,30,30,30,4,30,4,4,4,30,4,30,30,4,30,30,30,4],[4,4,4,4,4,30,4,30,30,30,4,30,4,30,4,4,30,4,30,4],[4,30,30,30,30,30,4,30,4,30,30,30,30,30,4,30,30,30,30,4],[4,30,4,4,4,30,30,30,4,4,4,30,4,4,4,30,4,4,30,4],[4,30,30,30,4,4,4,30,4,30,30,30,4,30,30,30,4,30,30,4],[4,30,4,30,30,30,30,30,4,30,4,30,4,30,4,30,30,30,30,4],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4]],d=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,1],[1,0,1,0,1,0,0,0,0,0,1,0,1,0,1,0,1,1,0,1],[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0,1,0,1],[1,0,1,0,0,0,1,0,1,0,0,0,0,0,1,1,0,1,0,1],[1,0,1,1,1,0,1,0,1,1,1,1,1,0,0,1,0,1,0,1],[1,0,0,0,0,0,0,0,1,0,1,0,1,1,0,0,0,0,0,1],[1,1,1,0,1,0,1,1,1,0,1,0,0,0,0,1,1,1,1,1],[1,0,0,0,1,0,1,0,0,0,0,0,1,1,0,1,0,0,0,1],[1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1],[1,0,0,0,1,1,1,0,0,0,0,0,1,1,1,1,0,1,0,1],[1,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,0,1,0,1],[1,0,1,1,1,0,1,0,1,0,1,1,1,1,0,1,0,1,1,1],[1,0,0,0,0,0,1,0,1,1,1,0,1,0,0,1,0,0,0,1],[1,1,1,1,1,0,1,0,0,0,1,0,1,0,1,1,0,1,0,1],[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,0,0,0,1,1,1,0,1,1,1,0,1,1,0,1],[1,0,0,0,1,1,1,0,1,0,0,0,1,0,0,0,1,0,0,1],[1,0,1,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],e=160,f=5,g=0,h=c.length,i=0,k=0;for(i=0,j=c.length;i<j;i++)for(k=0,l=c[i].length;k<l;k++)g<c[i].length&&(g=c[i].length);var m=.5,n=2,o=16,p=[[7*o,8*o],[1*o,1*o],[6*o,2*o],[9*o,11*o]];enchant();var q=new Game(a,b);q.preload(["img/map0.png","img/cursor.png","img/icon1.png","img/chara6.png","img/gameover.png"]),q.fps=60,q.score=0,q.onload=function(){var r=function(){var c=new Scene,d=new Sprite(a,b),e=new Surface(a,b);e.context.fillStyle="#000000",e.context.fillRect(0,0,a,b),d.image=e,d.opacity=.6,c.addChild(d);var f=new Label("score: "+q.score);f.color="#ffffff",f.x=65,f.y=60,f.font="40px sans-serif",c.addChild(f);var g=new Sprite(189,97);g.image=q.assets["img/gameover.png"],g.x=65,g.y=112,c.addChild(g);var h=new Label("please reload to retry.");return h.color="#ffffff",h.x=65,h.y=300,h.font="20px sans-serif",c.addChild(h),c},s=function(){var s=new Scene,t=Class.create(Map,{initialize:function(a,b,c){Map.call(this,o,o),this.image=a,this.loadData(b),c&&(this.collisionData=c)}}),u=Class.create(Sprite,{object3D:null,initialize:function(a,b,c){Sprite.call(this,o,o),this.x=b,this.y=c,this.image=a,this.frame=4,this.scale(.5,.5)},setObjectId:function(a){this.objectId=a},setObject3D:function(a){this.object3D=a}}),v=Class.create(Sprite,{isMove:!1,initialize:function(a,b,c){Sprite.call(this,o,o),this.x=b,this.y=c,this.image=a,this.rotation=90,this.addEventListener(enchant.Event.ENTER_FRAME,this.onEnterFrame)},onEnterFrame:function(){var a=0,b=0;this.isMove=!1,q.input.left&&(this.rotation-=n),q.input.right&&(this.rotation+=n),q.input.up&&(a=Math.cos(this.rotation*Math.PI/180)*m,b=Math.sin(this.rotation*Math.PI/180)*m,this.isMove=!0),q.input.down&&(a=Math.cos(this.rotation*Math.PI/180)*-m,b=Math.sin(this.rotation*Math.PI/180)*-m,this.isMove=!0),y.hitTest(this.x+a+11,this.y+b+8)?this.isMove=!1:y.hitTest(this.x+a+8,this.y+b+11)?this.isMove=!1:y.hitTest(this.x+a+5,this.y+b+8)?this.isMove=!1:y.hitTest(this.x+a+8,this.y+b+5)&&(this.isMove=!1),this.isMove&&(this.x+=a,this.y+=b)}}),w=Class.create(Sprite,{isMove:!1,previousFrame:0,direction:0,object3D:null,initialize:function(a,b,c){Sprite.call(this,2*o,2*o),this.x=b,this.y=c,this.image=a,this.rotation=0,this.frame=0,this.addEventListener(enchant.Event.ENTER_FRAME,this.onEnterFrame)},setObject3D:function(a){this.object3D=a},onEnterFrame:function(){this.isMove=!1;var a=0,b=0,c=[[o,0],[0,o],[-o,0],[0,-o]];if(q.frame>0&&q.frame%q.fps===0){var d;for(this.x=Math.round(this.x),this.y=Math.round(this.y),i=0;i<3;i++){if(d=this.direction%4,this.isMove=this.moveTest(c[d][0],c[d][1])){a=c[d][0],b=c[d][1];break}this.direction++}this.isMove&&(this.tl.moveTo(this.x+a,this.y+b,q.fps),new TWEEN.Tween(this.object3D.position).to({x:this.object3D.position.x+a/o*e,z:this.object3D.position.z+b/o*e},1e3).start())}q.frame%30===0&&(0===this.frame?(this.previousFrame=this.frame,this.frame=1):1===this.frame&&0===this.previousFrame?(this.previousFrame=this.frame,this.frame=2):1===this.frame&&2===this.previousFrame?(this.previousFrame=this.frame,this.frame=0):(this.previousFrame=this.frame,this.frame=1))},moveTest:function(a,b){var c=!0;return y.hitTest(this.x+a+o/2,this.y+b+o/2)&&(c=!1),c}}),x=new Group;x.x=16,x.y=16,s.addChild(x);var y=new t(q.assets["img/map0.png"],c,d);x.addChild(y);var z=new Group;for(i=0,j=c.length;i<j;i++)for(k=0,l=c[i].length;k<l;k++)if(30===c[i][k]){var A=new u(q.assets["img/icon1.png"],o*k,o*i);z.addChild(A)}x.addChild(z);var B=new v(q.assets["img/cursor.png"],o*g/2-o/2,o*h/2-o/2);x.addChild(B);var C=new Group;p.forEach(function(a){var b=new w(q.assets["img/chara6.png"],a[0]-o/2,a[1]-o/2);C.addChild(b)}),x.addChild(C);var D=new THREE.LoadingManager;D.onProgress=function(a,b,c){console.log(a,b,c)};var G=new THREE.OBJLoader(D),H=new THREE.TextureLoader(D),I=new THREE.Scene,J=new THREE.CubeGeometry(e,e,e),K=H.load("img/wall01.jpg"),L=new THREE.MeshPhongMaterial({map:K,bumpMap:K,bumpScale:.2});for(i=0,j=c.length;i<j;i++)for(k=0,l=c[i].length;k<l;k++)if(4===c[i][k]){var M=new THREE.Mesh(J,L);M.position.set(e*k,e/2,e*i),I.add(M)}var N=new THREE.PlaneGeometry(e,e),O=H.load("img/land01.jpg"),P=new THREE.MeshPhongMaterial({map:O,side:THREE.DoubleSide,bumpMap:O,bumpScale:.2});for(i=0,j=c.length;i<j;i++)for(k=0,l=c[i].length;k<l;k++)if(30===c[i][k]){var Q=new THREE.Mesh(N,P);Q.position.set(e*k,0,e*i),Q.rotation.x=90*Math.PI/180,I.add(Q)}var R=new THREE.PlaneGeometry(e,e),S=H.load("img/wall01.jpg"),T=new THREE.MeshPhongMaterial({map:S,side:THREE.DoubleSide,bumpMap:S,bumpScale:.2});for(i=0,j=c.length;i<j;i++)for(k=0,l=c[i].length;k<l;k++)if(30===c[i][k]){var Q=new THREE.Mesh(R,T);Q.position.set(e*k,e,e*i),Q.rotation.x=90*Math.PI/180,I.add(Q)}var U=new THREE.SphereGeometry(f),V=new THREE.MeshPhongMaterial({color:16776960});z.childNodes.forEach(function(a){var b=new THREE.Mesh(U,V);b.position.set(e*a.x/o,40,e*a.y/o),I.add(b),a.setObject3D(b)}),G.load("img/Space_Invader.obj",function(a){a.scale.set(.6,.6,.6),C.childNodes.forEach(function(b){var c=a.clone();c.position.set(e*(b.x+o/2)/o,60,e*(b.y+o/2)/o),I.add(c),b.setObject3D(c)})});var W=new THREE.PointLight(16777215,1.5,300);W.position.set(0,e/2,0),I.add(W);var X=new THREE.AmbientLight(3355443);I.add(X);var Y=new THREE.PerspectiveCamera(45,a/b,1,1e4);Y.position.set(0,e/2,0);var Z=new THREE.WebGLRenderer;Z.setSize(a,b),Z.setClearColor(0,1),Z.shadowMap.enabled=!0;var $=document.getElementById("three-canvas");return $.appendChild(Z.domElement),s.addEventListener(enchant.Event.ENTER_FRAME,function(){Y.rotation.y=-((B.rotation+90)*Math.PI/180),Y.position.z=B.y*(e/o),Y.position.x=B.x*(e/o),W.rotation.y=-((B.rotation+90)*Math.PI/180),W.position.z=B.y*(e/o),W.position.x=B.x*(e/o),TWEEN.update(),Z.render(I,Y)}),z.addEventListener("enterframe",function(){this.childNodes.forEach(function(a){a.within(B,o)&&(I.remove(a.object3D),a.parentNode.removeChild(a),q.score+=10)})}),C.addEventListener("enterframe",function(){this.childNodes.forEach(function(a){a.within(B,o/2)&&q.replaceScene(r())})}),s};q.replaceScene(s())},q.start()}();
